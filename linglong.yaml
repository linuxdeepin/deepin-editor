# SPDX-FileCopyrightText: 2023 - 2026 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: GPL-3.0-or-later

version: "1"

package:
  id: org.deepin.editor
  name: "deepin-editor"
  version: 6.5.43.1
  kind: app
  description: |
    editor for deepin os.

base: org.deepin.base/25.2.2
runtime: org.deepin.runtime.webengine/25.2.2

command:
  - deepin-editor

build: |
  # 下载和安装依赖
  apt -y install --download-only qt6-5compat-dev qt6-base-dev qt6-tools-dev-tools qt6-tools-dev qt6-base-private-dev qt6-svg-dev libdtk6widget-dev libdtk6gui-dev libdtk6core-dev libdtk6declarative-dev libpolkit-qt6-1-dev libkf6syntaxhighlighting-dev libkf6codecs-dev libgtest-dev libgmock-dev libchardet-dev libuchardet-dev libicu-dev deepin-event-log
  bash ./install_dep /var/cache/apt/archives "$PREFIX"

  # 修改路径
  sed -i 's|set(QT_LRELEASE "/lib/qt${QT_VERSION_MAJOR}/bin/lrelease")|set(QT_LRELEASE "lrelease")|g' cmake/translation-generate.cmake

  # 构建
  VERSION=$(head -1 debian/changelog | awk -F'[()]' '{print $2}')
  cmake -B build ${conf_args} \
        -DCMAKE_SAFETYTEST_ARG="CMAKE_SAFETYTEST_ARG_OFF" \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX="${PREFIX}" \
        -DVERSION=${VERSION}
  cmake --build build -j`nproc`
  cmake --build build --target install > install.log 2>&1

  # 项目生成应用名和动态隐式加载的依赖库，ldd无法找到的其他库
  LDD_FILES=(
    deepin-editor
    libdeepin-event-log.so
    libzpdcallback.so
  )

  # 生成.install 文件
  bash ./deploy_dep "${LDD_FILES[@]}"

# allow apt download in build and do apt update
buildext:
  apt:
    build_depends:
      - libc6
